# 支付模块
    负责人：张行
## 模块作用
1、应用中用于付款购买会员的模块，共有两种会员<br>
2、可以记录消费，判断是否付款成功<br>
3、可以判断会员是否过期和查询用户开通的会员
## 数据库表
### consumption_history（消费记录）表
| 字段名 | 类型       | 说明      |
| --- |----------|---------|
| trade_no | char(32) |  订单号（主键）      |
| user_id | int      | 用户id（外键，与User表中id对应）    |
| trade_time | datetime | 交易时间    |
| trade_spent | float    | 消费金额    |
| is_success | bool     | 是否成功    |
| trade_description | char(4)  | 会员类型  |
#### 说明
用做消费记录，无论交易是否成功，都会记录
### continue_time（会员持续时间）表
| 字段名 | 类型       | 说明      |
| --- |----------|---------|
| id | int      |  django自动生成的主键      |
| user | int      | 用户id（外键，与User表中id对应）    |
| type | char(4)  | 会员类型    |
| deadline | datetime | 会员截止时间    |
#### 说明
主要用于查询用户会员是否到期和更新会员到期时间
## 功能细节
### 付款部分
#### 说明
通过调用支付宝沙箱环境的API来模拟真实情况，如果要真正实现付款，需要提供营业执照。另外微信支付似乎没有沙箱环境，所以就没有调用微信支付
#### 过程
1、在支付宝开放平台中获取获取应用公钥、支付宝公钥、APP_id等
<br>
2、设置好两种套餐，用uuid生成订单号，并结合上一条获取到信息配置支付宝
<br>
3、接收POST请求中的参数，获取用户id和选择的套餐
<br>
4、若用户已开通会员，并且和现在要开通的会员类型不同，就阻止用户开通会员，并告知要等到之前的会员到期再开通，否则进行下一步
<br>
5、向consumption_history（消费记录）表中保存用户id、套餐类别、订单号等，is_success（是否支付成功）字段默认为False
<br>
6、设置支付完成后的跳转url，（当支付成功后支付宝回向这个url发送GET请求）
<br>
7、调用向支付宝发送请求，支付宝会返回一个url，进入该url即可进行支付
### 付款确认部分
#### 说明
这里就是付款过程中给支付宝设置的跳转url，支付宝会向这个url发送GET请求，其中参数包含订单号
#### 过程
1、获取GET请求中的订单号，根据订单号找到consumption_history表中对应的记录，获取用户id，会员类型等信息
<br>
2、将is_success（是否支付成功）字段改为True，表示支付成功
<br>
3、根据用户id在User表中查看用户是否开通会员
<br>
4、若用户已开通会员，则更新截止时间
<br>
5、否则在continue_time（会员持续时间）表中新增记录，记录会员的到期时间、用户id和订单号
<br>
6、在User表中修改用户的会员类型（如果需要）
### 查询用户会员和判断会员是否过期
#### 说明
我将这两个功能进行了合并，也就是说在查会员的时候会判断会员是否过期，以此来修改User表和返回数据
#### 过程
1、获取POST请求中的用户id
<br>
2、在User表中根据用户id获取用户的记录
<br>
3、若此时用户的会员类型为 “free”， 则直接返回 “free”
<br>
4、否则先根据用户id在continue_time（会员持续时间）表中找到响应记录，获取会员到期时间
<br>
5、将到期时间与当前时间进行比较，若未到期，则返回用户对应的会员类型
<br>
6、若已经到期，则将User表中用户的会员类型改为 “free”，并返回 “free”

## 目前的问题
支付宝付款时不成功，一开始并没有这个问题，后来才有，可能是因为之前使用此时过多，现在有了限制
